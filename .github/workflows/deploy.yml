name: Deploy to cPanel

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci || npm install

      # ---------- Build version ----------
      - name: Set build version
        id: set_version
        run: |
          SHORT_SHA="$(echo "$GITHUB_SHA" | cut -c1-7)"
          VERSION="${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
          echo "build_version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build project
        run: npm run build

      # ---------- Deploy to cPanel via FTP ----------
      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}
          protocol: ftp
          local-dir: ./dist/
          server-dir: ${{ secrets.FTP_REMOTE_DIR }}
          dangerous-clean-slate: true

      # ---------- Discord success embed ----------
      - name: Notify Discord (success)
        if: success()
        run: |
          VERSION="${{ steps.set_version.outputs.build_version }}"
          SHORT_SHA="$(echo "$GITHUB_SHA" | cut -c1-7)"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          AVATAR_URL="https://github.com/${{ github.actor }}.png"

          jq -nc --arg username "DeployaBOT" \
                --arg content "" \
                --arg url "$RUN_URL" \
                --arg domain "fattieslearnscoding.com" \
                --arg status "✅ Deploy succeeded" \
                --arg version "$VERSION" \
                --arg commit "${{ github.sha }}" \
                --arg commitUrl "$COMMIT_URL" \
                --arg branch "${{ github.ref_name }}" \
                --arg actor "${{ github.actor }}" \
                --arg avatar "$AVATAR_URL" \
                --arg runNumber "${{ github.run_number }}" \
                '
                {
                  username: $username,
                  avatar_url: $avatar,
                  content: $content,
                  embeds: [
                    {
                      title: "\($domain) deployed",
                      url: $url,
                      description: $status,
                      color: 5763719,
                      fields: [
                        { name: "Version", value: $version, inline: true },
                        { name: "Run #",  value: $runNumber, inline: true },
                        { name: "Branch", value: $branch, inline: true },
                        { "name": "Commit", "value": "`$SHORT_SHA` ($COMMIT_URL)" }
                      ],
                      footer: {
                        text: "Triggered by \($actor)"
                      },
                      timestamp: (now | todate)
                    }
                  ]
                }
                ' --arg commitShort "$(echo "${{ github.sha }}" | cut -c1-7)" \
            > payload.json

          curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "${{ secrets.DISCORD_WEBHOOK }}"

      # ---------- Discord failure embed ----------
      - name: Notify Discord (failure)
        if: failure()
        run: |
          VERSION="${{ steps.set_version.outputs.build_version }}"
          SHORT_SHA="$(echo "$GITHUB_SHA" | cut -c1-7)"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          AVATAR_URL="https://github.com/${{ github.actor }}.png"

          jq -nc --arg username "DeployaBOT" \
                --arg content "" \
                --arg url "$RUN_URL" \
                --arg domain "fattieslearnscoding.com" \
                --arg status "❌ Deploy failed" \
                --arg version "$VERSION" \
                --arg commit "${{ github.sha }}" \
                --arg commitUrl "$COMMIT_URL" \
                --arg branch "${{ github.ref_name }}" \
                --arg actor "${{ github.actor }}" \
                --arg avatar "$AVATAR_URL" \
                --arg runNumber "${{ github.run_number }}" \
                '
                {
                  username: $username,
                  avatar_url: $avatar,
                  content: $content,
                  embeds: [
                    {
                      title: "\($domain) deploy failed",
                      url: $url,
                      description: $status,
                      color: 15548997,
                      fields: [
                        { name: "Version", value: $version, inline: true },
                        { name: "Run #",  value: $runNumber, inline: true },
                        { name: "Branch", value: $branch, inline: true },
                        { "name": "Commit", "value": "`$SHORT_SHA` ($COMMIT_URL)" }
                      ],
                      footer: {
                        text: "Triggered by \($actor)"
                      },
                      timestamp: (now | todate)
                    }
                  ]
                }
                ' --arg commitShort "$(echo "${{ github.sha }}" | cut -c1-7)" \
            > payload.json

          curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "${{ secrets.DISCORD_WEBHOOK }}"
