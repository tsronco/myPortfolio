name: Deploy to cPanel

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    #change this url for your different apps
    env:
      CHANGELOG_URL: https://fattieslearnscoding.com/changelog?version=$VERSION&commit=$SHORT_SHA

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci || npm install

      # ---------- Build version ----------
      - name: Set build version
        id: set_version
        run: |
          SHORT_SHA="$(echo "$GITHUB_SHA" | cut -c1-7)"
          VERSION="${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
          echo "build_version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Build project
        run: npm run build

      - name: Show build output
        run: |
          echo "Contents of dist:"
          ls -R dist

      - name: Write latest changelog metadata
        run: |
          SHORT_SHA="$(echo "$GITHUB_SHA" | cut -c1-7)"
          VERSION="${GITHUB_RUN_NUMBER}-${SHORT_SHA}"

          mkdir -p dist/changelog

          cat > dist/latest.json << 'EOF'
          {
            "version": "__VERSION__",
            "commit": "__COMMIT__",
            "commitUrl": "__COMMIT_URL__"
          }
          EOF

          # Replace placeholders
          sed -i "s/__VERSION__/$VERSION/" dist/latest.json
          sed -i "s/__COMMIT__/$SHORT_SHA/" dist/latest.json
          sed -i "s#__COMMIT_URL__#https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}#" dist/latest.json


      # ---------- Deploy to cPanel via FTP ----------
      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}
          protocol: ftp
          local-dir: ./dist/
          server-dir: ${{ secrets.FTP_REMOTE_DIR }}
          dangerous-clean-slate: true

      # ---- TEMP: force a failure to test Discord ----
      #- name: TEMP – Force failure to test Discord
      # run: |
      #   echo "Forcing a failure so we can test the emergency webhook..."
      #   exit 1
        

      # ---------- Discord success embed ----------
      - name: Notify Discord (success)
        if: success()
        run: |
          VERSION="${{ steps.set_version.outputs.build_version }}"
          SHORT_SHA="$(echo "$GITHUB_SHA" | cut -c1-7)"
          RUN_URL="https://fattieslearnscoding.com"
          CHANGELOG_URL="${{ env.CHANGELOG_URL }}"
          AVATAR_URL="https://github.com/${{ github.actor }}.png"

          jq -nc \
            --arg username "DeployaBOT" \
            --arg url "$RUN_URL" \
            --arg domain "www.fattieslearnscoding.com" \
            --arg status "✅ Deployment succeeded" \
            --arg version "$VERSION" \
            --arg commitShort "$SHORT_SHA" \
            --arg changelogUrl "$CHANGELOG_URL" \
            --arg branch "${{ github.ref_name }}" \
            --arg actor "${{ github.actor }}" \
            --arg avatar "$AVATAR_URL" \
            --arg runNumber "${{ github.run_number }}" \
            '
            {
              username: $username,
              avatar_url: $avatar,
              embeds: [
                {
                  title: "\($domain)",
                  url: $url,
                  description: $status,
                  color: 5763719,
                  fields: [
                    { name: "Version", value: $version, inline: true },
                    { name: "Run #",  value: $runNumber, inline: true },
                    { name: "Branch", value: $branch, inline: true },
                    {
                      name: "Changelog",
                      value: "[\($commitShort)](\($changelogUrl))",
                    }
                  ],
                  footer: {
                    text: "Triggered by Fatty"
                  },
                  timestamp: (now | todate)
                }
              ]
            }
            ' > payload.json

          curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "${{ secrets.DISCORD_WEBHOOK }}"

      # ---------- Discord failure embed ----------
      - name: Notify Discord (failure)
        if: failure()
        run: |
          VERSION="${{ steps.set_version.outputs.build_version }}"
          SHORT_SHA="$(echo "$GITHUB_SHA" | cut -c1-7)"
          RUN_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          AVATAR_URL="https://github.com/${{ github.actor }}.png"

          jq -nc \
            --arg username "Emergency 911" \
            --arg url "$RUN_URL" \
            --arg domain "www.fattieslearnscoding.com" \
            --arg status "❌ Deployment failed" \
            --arg version "$VERSION" \
            --arg commitShort "$SHORT_SHA" \
            --arg commitUrl "$COMMIT_URL" \
            --arg branch "${{ github.ref_name }}" \
            --arg actor "${{ github.actor }}" \
            --arg avatar "$AVATAR_URL" \
            --arg runNumber "${{ github.run_number }}" \
            '
            {
              username: $username,
              avatar_url: $avatar,
              embeds: [
                {
                  title: "\($domain)",
                  url: $url,
                  description: $status,
                  color: 15548997,
                  fields: [
                    { name: "Version", value: $version, inline: true },
                    { name: "Run #",  value: $runNumber, inline: true },
                    { name: "Branch", value: $branch, inline: true },
                    {
                      name: "Commit",
                      value: "[\($commitShort)](\($commitUrl))",
                      inline: false
                    }                    
                  ],
                  footer: {
                    text: "Triggered by Fatty"
                  },
                  timestamp: (now | todate)
                }
              ]
            }
            ' > payload.json

          curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "${{ secrets.DISCORD_FAIL }}"
